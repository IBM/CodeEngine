{"version":3,"names":["args","path","join","dirname","babelArgs","process","argv","slice","userArgs","argSeparator","indexOf","getNormalizedV8Flag","arg","matches","match","replace","aliases","Map","getV8Flags","err","v8Flags","i","length","flag","split","push","has","unshift","get","default","kexec","code","shouldPassthroughIPC","send","undefined","proc","child_process","spawn","stdio","on","signal","kill","pid","exitCode","message"],"sources":["../src/babel-node.ts"],"sourcesContent":["/**\n * This tiny wrapper file checks for known node flags and appends them\n * when found, before invoking the \"real\" _babel-node(1) executable.\n */\n\nimport getV8Flags from \"v8flags\";\nimport path from \"path\";\nimport child_process from \"child_process\";\nimport { fileURLToPath } from \"url\";\n\nconst args = [\n  path.join(path.dirname(fileURLToPath(import.meta.url)), \"_babel-node\"),\n];\n\nlet babelArgs = process.argv.slice(2);\nlet userArgs: string[];\n\n// separate node arguments from script arguments\nconst argSeparator = babelArgs.indexOf(\"--\");\nif (argSeparator > -1) {\n  userArgs = babelArgs.slice(argSeparator); // including the  --\n  babelArgs = babelArgs.slice(0, argSeparator);\n}\n\n/**\n * Replace dashes with underscores in the v8Flag name\n * Also ensure that if the arg contains a value (e.g. --arg=true)\n * that only the flag is returned.\n */\nfunction getNormalizedV8Flag(arg: string) {\n  // v8 uses the \"no\" prefix to negate boolean flags (e.g. --nolazy),\n  // but they are not listed by v8flags\n  const matches = arg.match(/--(?:no)?(.+)/);\n\n  if (matches) {\n    return `--${matches[1].replace(/-/g, \"_\")}`;\n  }\n\n  return arg;\n}\n\n// These are aliases for node options defined by babel-node.\nconst aliases = new Map([\n  [\"-d\", \"--debug\"],\n  [\"-gc\", \"--expose-gc\"],\n]);\n\ngetV8Flags(async function (err, v8Flags) {\n  for (let i = 0; i < babelArgs.length; i++) {\n    const arg = babelArgs[i];\n    const flag = arg.split(\"=\")[0];\n\n    if (flag === \"-r\" || flag === \"--require\") {\n      args.push(flag);\n      args.push(babelArgs[++i]);\n    } else if (aliases.has(flag)) {\n      args.unshift(aliases.get(flag) as string);\n    } else if (\n      flag === \"debug\" || // node debug foo.js\n      flag === \"inspect\" ||\n      v8Flags.indexOf(getNormalizedV8Flag(flag)) >= 0 ||\n      process.allowedNodeEnvironmentFlags.has(flag)\n    ) {\n      args.unshift(arg);\n    } else {\n      args.push(arg);\n    }\n  }\n\n  // append arguments passed after --\n  if (argSeparator > -1) {\n    args.push(...userArgs);\n  }\n\n  try {\n    const { default: kexec } = await import(\"kexec\");\n    kexec(process.argv[0], args);\n  } catch (err) {\n    if (\n      err.code !== \"ERR_MODULE_NOT_FOUND\" &&\n      err.code !== \"MODULE_NOT_FOUND\" &&\n      err.code !== \"UNDECLARED_DEPENDENCY\"\n    ) {\n      throw err;\n    }\n\n    // passthrough IPC only if babel-node itself has an IPC channel\n    const shouldPassthroughIPC = process.send !== undefined;\n    const proc = child_process.spawn(process.argv[0], args, {\n      stdio: shouldPassthroughIPC\n        ? [\"inherit\", \"inherit\", \"inherit\", \"ipc\"]\n        : \"inherit\",\n    });\n    proc.on(\"exit\", function (code, signal) {\n      process.on(\"exit\", function () {\n        if (signal) {\n          process.kill(process.pid, signal);\n        } else {\n          process.exitCode = code ?? undefined;\n        }\n      });\n    });\n    if (shouldPassthroughIPC) {\n      proc.on(\"message\", message => process.send(message));\n    }\n    process.on(\"SIGINT\", () => proc.kill(\"SIGINT\"));\n    process.on(\"SIGTERM\", () => proc.kill(\"SIGTERM\"));\n  }\n});\n"],"mappings":"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"}