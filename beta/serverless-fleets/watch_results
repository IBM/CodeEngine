#!/bin/sh

# get the current resource group name
resource_group_name=$(ibmcloud target -o JSON | jq -r '.resource_group.name')
region=$(ibmcloud target -o JSON | jq -r '.region.name')
cos_instance=${resource_group_name/--rg/}--cos

echo "switching to COS instance $cos_instance"

# configure the COS instance
crn=$(ibmcloud resource service-instance "${cos_instance}" -o json | jq -r '.[] | .crn')

ibmcloud cos config crn --crn $crn --force
ibmcloud cos config endpoint-url --url s3.$region.cloud-object-storage.appdomain.cloud 

bucket=$(ibmcloud cos buckets --json | jq -r '.Buckets[] | select( .Name | contains("output")) | .Name')

echo $bucket

watch -n 2 ibmcloud cos list-objects-v2 --bucket "$bucket" --prefix "$1"
